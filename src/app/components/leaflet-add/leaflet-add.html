<div class="leaflet-add-layout">
  <!-- ================= MAP COLUMN ================= -->
  <div class="map-col">
    <div class="map-toolbar">
      <mat-slide-toggle
        [checked]="showFetchedStops"
        (change)="showFetchedStops = $event.checked; applyFetchedVisibility()">
        Stops
      </mat-slide-toggle>

      <mat-slide-toggle
        [checked]="showFetchedLines"
        (change)="showFetchedLines = $event.checked; applyFetchedVisibility()">
        Lines
      </mat-slide-toggle>

      @if (loading) {
        <span class="status">Caricamento…</span>
      } @else if (error) {
        <span class="status error">{{ error }}</span>
      }
    </div>

    <div id="leafletAddMap" class="map"></div>
  </div>

  <!-- ================= PANEL COLUMN ================= -->
  <div class="panel-col">
    <section class="dashboard">
      <h2 class="dashboard__title">Stop editor</h2>

      <!-- ======= GLOBAL ACTIONS (sempre visibili) ======= -->
      <div class="dashboard__actions">
        <div class="badge">
          Modifiche pendenti: <strong>{{ pendingCount }}</strong>
        </div>

        <button
          matButton="elevated"
          color="primary"
          (click)="saveAllToDb()"
          [disabled]="pendingCount === 0">
          SAVE (DB)
        </button>
      </div>

      <mat-divider></mat-divider>

      <!-- ======= EDITOR STATE ======= -->
      @if (editorState) {
        <div class="badge">
          Modalità:
          <strong>{{ editorState.mode === 'create' ? 'NUOVO' : 'MODIFICA' }}</strong>
        </div>

        <!-- ID (readonly) -->
        <mat-form-field appearance="outline" class="dashboard__field">
          <mat-label>ID</mat-label>
          <input
            matInput
            [value]="editorState.stopId ?? '-ID- Assegnato dal DB'"
            readonly />
        </mat-form-field>

        <!-- Nome fermata -->
        <mat-form-field appearance="outline" class="dashboard__field">
          <mat-label>Nome fermata</mat-label>
          <input
            matInput
            [(ngModel)]="editorState.name"
            placeholder="Es. Brignole" />
        </mat-form-field>

        <!-- Lat/Lng (readonly) -->
        <div class="field grid2">
          <mat-form-field appearance="outline" class="dashboard__field">
            <mat-label>Lat</mat-label>
            <input matInput [value]="editorState.lat ?? '—'" readonly />
          </mat-form-field>

          <mat-form-field appearance="outline" class="dashboard__field">
            <mat-label>Lng</mat-label>
            <input matInput [value]="editorState.lng ?? '—'" readonly />
          </mat-form-field>
        </div>

        <div class="dashboard__actions">
          <button
            matButton="elevated"
            color="primary"
            (click)="applyStopToDraft()"
            [disabled]="!editorState.name.trim()">
            Applica (draft)
          </button>

          <button
            matButton="elevated"
            color="warn"
            (click)="markDeleteCurrent()"
            [disabled]="editorState.mode !== 'edit'">
            Elimina fermata
          </button>

          <button
            matButton="elevated"
            (click)="cancelSelection()">
            Annulla
          </button>
        </div>
      } @else {
        <div class="empty">
          Seleziona una fermata sulla mappa oppure crea un nuovo marker.
        </div>
      }
    </section>
  </div>
</div>
